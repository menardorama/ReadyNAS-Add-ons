#!/bin/sh
# postinst script for headphones
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <postinst> `abort-remove'
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package

case "$1" in
    	configure)
		###
		# Create our Master Share

		###
            	# Create a share with the name of the app

      		app_name=headphones
      		partage=`rn_nml -g shares | grep $app_name| awk -F"\" " '{print $1}'|  awk -F"\=\"" '{print $2}'`

		echo $partage

		if [ -z  "${partage}" ]; then
       			rn_nml -a share:/*/$app_name
       			partage=`rn_nml -g shares | grep $app_name | awk -F"\"" '{print $2}'`
       			#chown guest:guest /$Partage/ -R
      		else
       			echo "share exist"
       			partage=`rn_nml -g shares | grep $app_name | awk -F"\"" '{print $2}'`
      		fi

    		if [ -z "${partage}" ]; then
      			echo "empty partage"
      			exit 1
     		else
      			chmod 770 /${partage}
    		fi

		if [ ! -d /apps/headphones/config ]; then
			mkdir -p /apps/headphones/config
		fi

		chown -R admin:admin /apps/headphones/config/.

		if [ ! -f /apps/headphones/config/config.ini ]; then
	    		echo "create config.ini from config.ini.dist and copy sample ssl certificates"
	    		cp /apps/headphones/defaults/config.ini.dist /apps/headphones/config/config.ini
	    		cp /apps/headphones/defaults/server.crt /apps/headphones/config/
	    		cp /apps/headphones/defaults/server.key /apps/headphones/config/
		fi

		if [ ! -f /apps/headphones/config/logs/headphones.log ]; then
			echo "making the log"
			mkdir -p /apps/headphones/config/logs
			touch /apps/headphones/config/logs/headphones.log
			chmod 777 /apps/headphones/config/logs/headphones.log
		else
	        	echo "mod permissions on logs"
			chmod 777 /apps/headphones/config/logs/headphones.log
		fi

		mkdir -p /apps/headphones/config/cache
		chown -R admin:admin /apps/headphones
		chmod 777 /apps/headphones/config
	;;

    	abort-upgrade|abort-remove|abort-deconfigure)
    	;;

    	*)
        	echo "postinst called with unknown argument \`$1'" >&2
        	exit 1
    	;;
esac

###
# Restart Apache (required to show logo)
###
echo "restarting Apache2"
if systemctl restart apache2.service; then
  	echo "success"
  	event_push app readynasd '<add-s resource-type="LocalApp" resource-id="LocalApp"><LocalApp appname="headphones" success="1"/></add-s>' 0 0
else
  	echo "failure"
  	event_push app readynasd '<add-s resource-type="LocalApp" resource-id="LocalApp"><LocalApp appname="headphones" success="0"/></add-s>' 0 0
fi

sleep 3

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

# Automatically added by dh_makeshlibs
if [ "$1" = "configure" ]; then
	ldconfig
fi
# End automatically added section

exit 0
